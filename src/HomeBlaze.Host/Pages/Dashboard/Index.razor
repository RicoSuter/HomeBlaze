@page "/"

@using Blazor.Diagrams.Core
@using Blazor.Diagrams.Core.Geometry;
@using Blazor.Diagrams.Core.Models
@using Blazor.Diagrams.Components
@using HomeBlaze.Abstractions.Attributes;
@using HomeBlaze.Abstractions.Messages;
@using HomeBlaze.Abstractions.Services;
@using HomeBlaze.Abstractions;
@using HomeBlaze.Components.Dialogs;
@using HomeBlaze.Host.Shared;
@using HomeBlaze.Host.Infrastructure;
@using HomeBlaze.Things;

@using System.Reflection;

@inject IThingManager ThingManager
@inject IThingStorage ThingStorage
@inject IDialogService DialogService
@inject IEventManager EventManager
@inject NavigationManager Navigation

<SectionContent Name="AppBar">
    @foreach (var dashboard in _dashboards)
    {
        <MudToggleIconButton Icon="@("fas fa-" + dashboard.Icon)"
                         ToggledIcon="@("fas fa-" + dashboard.Icon)"
                         Style="@("color: white; opacity: " + (dashboard == _selectedDashboard ? "1.0" : "0.5"))"
                         Toggled="dashboard == _selectedDashboard"
                         ToggledChanged="@(value => { if (value) { Navigation.NavigateTo("?name=" + dashboard.Name); } })"
                         Class="mr-2" />
    }

    @if (_selectedDashboard != null && _diagram != null)
    {
        @if (_isEditMode)
        {
            <MudButton StartIcon="@Icons.Filled.Add" OnClick="AddDashboard" Color="Color.Primary">Add Dashboard</MudButton>
            <MudButton StartIcon="@Icons.Filled.Edit" OnClick="EditDashboard">Edit</MudButton>
            @if (_dashboards.Length > 1)
            {
                <MudButton StartIcon="@Icons.Filled.Delete" Color="Color.Error" OnClick="DeleteDashboard">Delete</MudButton>
            }
        }

        <MudSpacer />

        @if (_isEditMode)
        {
            <MudButton StartIcon="@Icons.Filled.Add" Color="Color.Primary" OnClick="AddWidget">Add Widget</MudButton>

            @if (_diagram.GetSelectedModels().Any())
            {
                <MudButton StartIcon="@Icons.Filled.MoveUp" OnClick="MoveSelectedWidgetToTop">Move to Top</MudButton>
                <MudButton StartIcon="@Icons.Filled.ContentCopy" OnClick="CloneSelectedWidget">Clone</MudButton>
                <MudButton StartIcon="@Icons.Filled.Delete" OnClick="DeleteSelectedWidget" Color="Color.Error">Delete</MudButton>
            }
        }

        <MudIconButton OnClick="ToggleEditMode" Icon="@(_isEditMode ? Icons.Filled.Close : Icons.Filled.Edit)" />
    }
</SectionContent>

<style>
    .dashboard {
        color: @(MainLayout.UseDarkTheme ? "#ffffff" : "#000000");
    }

    .locked {
        pointer-events: none !important;
    }
</style>

<CascadingValue Value="_diagram">
    <DiagramCanvas Class="dashboard"></DiagramCanvas>
</CascadingValue>