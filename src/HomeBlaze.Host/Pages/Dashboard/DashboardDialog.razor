@using HomeBlaze.Abstractions.Services;
@using HomeBlaze.Components.Inputs;
@using HomeBlaze.Services.Json;
@using MudBlazor;
@using System.Text.Json;
@using HomeBlaze.Things;

@inject IThingManager ThingManager
@inject IDialogService DialogService

<MudDialog ClassContent="edit-dialog">
    <TitleContent>@(DialogInstance?.Title)</TitleContent>
    <DialogContent>
        @if (Dashboard != null)
        {
            <MudForm @bind-IsValid="_isFormValid">
                <MudTextField @bind-Value="Dashboard.Name" Label="Name ([a-z]+)" Required="true" Pattern="[a-z]+" />
                <IconTextField @bind-Value="Dashboard.Icon" Label="Icon" Required="true" />
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => DialogInstance?.Close(null))" Color="Color.Primary">Close</MudButton>
        <MudButton OnClick="@(() => DialogInstance?.Close(Dashboard))" Disabled="!_isFormValid"
                   Variant="Variant.Filled" Color="Color.Primary">
            @SaveButtonText
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool _isFormValid;

    [Parameter]
    public Dashboard? Dashboard { get; set; }

    [Parameter]
    public string? SaveButtonText { get; set; }

    [CascadingParameter]
    public MudDialogInstance? DialogInstance { get; set; }

    public static async Task<Dashboard?> CreateAsync(IDialogService dialogService)
    {
        var dashboard = new Dashboard();
        if (await ShowAsync(dialogService, dashboard, "Add Dashboard", "Create Dashboard"))
        {
            return dashboard;
        }

        return null;
    }

    public static async Task<bool> EditAsync(IDialogService dialogService, Dashboard dashboard)
    {
        return await ShowAsync(dialogService, dashboard, "Edit Dashboard", "Update Dashboard");
    }

    private static async Task<bool> ShowAsync(IDialogService dialogService, Dashboard dashboard, string title, string button)
    {
        var result = await dialogService.Show<DashboardDialog>(title,
            new DialogParameters
            {
                { 
                    "Dashboard",
                    new Dashboard
                    {
                        Name = dashboard.Name,
                        Icon = dashboard.Icon,
                    }
                },
                { "SaveButtonText", button }
            },
            new DialogOptions
            {
                FullWidth = true,
                MaxWidth = MaxWidth.Small
            }).Result;

        if (result?.Cancelled == false && result.Data is Dashboard clonedDashboard)
        {
            dashboard.Name = clonedDashboard.Name;
            dashboard.Icon = clonedDashboard.Icon;
            return true;
        }

        return false;
    }
}